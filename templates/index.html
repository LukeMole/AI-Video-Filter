<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <title>AI Filter</title>
</head>
<body>
    <div class="left">
        <div class="checkbox-container first-checkbox">
            <input type="checkbox" id="clearFrameCache" name="clearFrameCache">
            <label for="clearFrameCache">Clear frame cache</label>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="halveVideoFps" name="halveVideoFps">
            <label for="halveVideoFps">Halve video FPS</label>
        </div>        

        <div class="mobile-button">
            <button class="video-import" id="importVideoFile">Import video from file</button>
            <input type="file" id="videoFileInput" accept="video/*" style="display: none;">
        </div>

        <hr>

        <p class="metadata" id="sourceName">Source name:</p>
        <p class="metadata" id="totalFrames">Total frames:</p>
        <p class="metadata" id="finalFramerate">Final framerate:</p>
        <p class="metadata" id="sourceResolution">Source resolution:</p>
        <p class="metadata" id="finalResolution">Final resolution:</p>

        <hr>

        <p class="metadata">Time remaining: <span id="timeRemaining">00:00:00</span></p>
        <p class="metadata">Frames remaining: <span id="framesRemaining">0</span></p>
        <p class="metadata">Progress: <span id="progressPercentage">0%</span></p>
    </div>
    <div class="center">
        <img class="aiGeneratedImage" id="aiGeneratedImage">
        <h1 id="aiText">AI Generated Frame</h1>
    </div>
    <div class="right">
        <div class="control-panel">
            <h2 class="prompt-heading">Prompt:</h2>
            <textarea id="promptInput" class="prompt" name="prompt" rows="5", required ></textarea>
    
            <h3 class="seed-heading">Seed value:</h3>
            <div class="seed-container">
                <input class="seed-number" id="seedNumber" type="number" max="2147483647" value="{{seed}}">
                <button class="refresh-button" id="refreshArrow"><img class="refresh-arrow" src="{{ url_for('static', filename='refreshArrow.png') }}"></button>
            </div>
            <div class="frame-select">
                <div>
                    <input class="frame" type="number" id="startFrame">
                    <h3 class="frame-heading">Start frame</h3>
                </div>
                <hr class="frame-divider">
                <div>
                    <input class="frame" type="number" id="endFrame">
                    <h3 class="frame-heading">End frame</h3>
                </div>
            </div>
        </div>

        <div class="checkbox-container-right">
            <input type="checkbox" id="turbo" name="turbo">
            <label for="turbo">Turbo</label>
        </div>
        <button class="right-button" id="renderButton">Render Frames</button>
        <hr>
        <div class="checkbox-container-right">
            <input type="checkbox" id="includeSourceAudio" name="includeSourceAudio">
            <label for="includeSourceAudio">Include source audio</label>
        </div>
        <button class="right-button">Compile Frames</button>
    </div>

<script>
let eventSource = null;

function connectToProgressStream() {
    if (eventSource) {
        eventSource.close();
    }
    
    eventSource = new EventSource('/progress_stream');
    
    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log('Received progress data:', data); // Debug log
        
        if (data.type === 'progress') {
            updateProgressDisplay(data);
        } else if (data.type === 'complete') {
            handleGenerationComplete(data);
        } else if (data.type === 'heartbeat') {
            // Just a heartbeat, do nothing
        }
    };
    
    eventSource.onerror = function(event) {
        console.log('EventSource failed.');
        // Auto-reconnect after 3 seconds
        setTimeout(connectToProgressStream, 3000);
    };
}

function updateProgressDisplay(data) {
    console.log('Updating display with:', data); // Debug log
    document.getElementById('timeRemaining').textContent = data.time_remaining;
    document.getElementById('framesRemaining').textContent = data.frames_remaining;
    document.getElementById('progressPercentage').textContent = data.progress_percentage + '%';
    const timestamp = new Date().getTime();
    document.getElementById('aiGeneratedImage').src = '{{ url_for("static", filename="temp/") }}' + (data.current_frame) + '.jpg?t=' + timestamp;
    document.getElementById('aiText').style.display = 'none';

    if (data.frame_processing_time) {
        console.log(`Frame processed in ${data.frame_processing_time}`);
    }
}

function handleGenerationComplete(data) {
    document.getElementById('timeRemaining').textContent = '00:00:00';
    document.getElementById('framesRemaining').textContent = '0';
    document.getElementById('progressPercentage').textContent = '100%';
    document.getElementById('progressBar').style.width = '100%';
    
    const renderButton = document.getElementById('renderButton');
    renderButton.textContent = 'Frames Generated';
    
    setTimeout(() => {
        renderButton.textContent = 'Render Frames';
        // Reset progress display
        document.getElementById('timeRemaining').textContent = '00:00:00';
        document.getElementById('framesRemaining').textContent = '0';
        document.getElementById('progressPercentage').textContent = '0%';
        document.getElementById('currentFrame').textContent = '-';
        document.getElementById('totalFramesToProcess').textContent = '-';
        document.getElementById('progressBar').style.width = '0%';
    }, 3000);
    
    console.log(data.message);
}

// Connect to progress stream when page loads
document.addEventListener('DOMContentLoaded', function() {
    connectToProgressStream();
});

// Close EventSource when page is unloaded
window.addEventListener('beforeunload', function() {
    if (eventSource) {
        eventSource.close();
    }
});

    document.getElementById('importVideoFile').addEventListener('click', function() {
        document.getElementById('videoFileInput').click();
    });

    document.getElementById('videoFileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if(!file) return;

        const formData = new FormData();
        formData.append('video', file);

        const clearFrameCache = document.getElementById('clearFrameCache').checked;
        formData.append('clearFrameCache', clearFrameCache ? 'on':'off');

        const halveFps = document.getElementById('halveVideoFps').checked;
        formData.append('halveFps', halveFps ? 'on':'off');

        const uploadButton = document.getElementById('importVideoFile');
        uploadButton.textContent = 'Importing...'
        fetch('/upload_video', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            uploadButton.textContent = 'Video imported';
            document.getElementById('sourceName').textContent = 'Source name: ' + data.filename;
            document.getElementById('totalFrames').textContent = 'Total frames: ' + data.frames;
            document.getElementById('finalFramerate').textContent = 'Final framerate: ' + data.framerate + ' fps'
            document.getElementById('sourceResolution').textContent = 'Source resolution: ' + data.base_resolution_x + ' x ' + data.base_resolution_y;
            document.getElementById('finalResolution').textContent = 'Final resolution: ' + data.final_resolution_x + ' x ' + data.final_resolution_y;
            document.getElementById('startFrame').value = 1;
            document.getElementById('endFrame').value = data.frames;
            document.getElementById('endFrame').max = data.frames;
        })
        .catch(error => {
            uploadButton.textContent = 'Import error'
        })
        .finally(() => {
                // Clear the file input value so the same file can be selected again
                event.target.value = '';
                
                const timeoutId = setTimeout(() => {
                    uploadButton.textContent = 'Import video from file';
                }, 2000);
            });
    })

    document.getElementById('refreshArrow').addEventListener('click', function(){
        fetch('/generate_seed')
        .then(response => response.json())
        .then(data => {
            document.getElementById('seedNumber').value = data.seed;
        })
    })

document.getElementById('renderButton').addEventListener('click', function(){
    const formData = new FormData();
    
    // Get all the form values
    const prompt = document.getElementById('promptInput').value;
    const seed = document.getElementById('seedNumber').value;
    const startFrame = document.getElementById('startFrame').value;
    const endFrame = document.getElementById('endFrame').value;
    const turbo = document.getElementById('turbo').checked;
    
    // Basic validation
    if (!prompt.trim()) {
        alert('Please enter a prompt');
        return;
    }
    
    if (!startFrame || !endFrame) {
        alert('Please select frame range');
        return;
    }
    
    if (parseInt(startFrame) > parseInt(endFrame)) {
        alert('Start frame must be less than or equal to end frame');
        return;
    }
    
    // Add them to form data
    formData.append('prompt', prompt);
    formData.append('seed', seed);
    formData.append('startFrame', startFrame);
    formData.append('endFrame', endFrame);
    formData.append('turbo', turbo ? 'on' : 'off');
    
    // Update button text and disable it
    const renderButton = document.getElementById('renderButton');
    renderButton.textContent = 'Starting Generation...';
    renderButton.disabled = true;
    
    // Reset progress display
    document.getElementById('timeRemaining').textContent = 'Starting...';
    document.getElementById('framesRemaining').textContent = 'Calculating...';
    document.getElementById('progressPercentage').textContent = '0%';
    
    fetch('/generate_frames', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderButton.textContent = 'Generating...';
            console.log('Frame generation started');
        } else {
            renderButton.textContent = 'Error Starting Generation';
            renderButton.disabled = false;
            console.error('Error starting generation:', data.error);
        }
    })
    .catch(error => {
        renderButton.textContent = 'Network Error';
        renderButton.disabled = false;
        console.error('Network error:', error);
        setTimeout(() => {
            renderButton.textContent = 'Render Frames';
        }, 3000);
    });
});

// Re-enable button when generation completes
function handleGenerationComplete(data) {
    document.getElementById('timeRemaining').textContent = '00:00:00';
    document.getElementById('framesRemaining').textContent = '0';
    document.getElementById('progressPercentage').textContent = '100%';
    
    const renderButton = document.getElementById('renderButton');
    renderButton.textContent = 'Frames Generated';
    renderButton.disabled = false;
    
    setTimeout(() => {
        renderButton.textContent = 'Render Frames';
        // Reset progress display
        document.getElementById('timeRemaining').textContent = '00:00:00';
        document.getElementById('framesRemaining').textContent = '0';
        document.getElementById('progressPercentage').textContent = '0%';
    }, 3000);
    
    console.log(data.message);
}

</script>
</body>
</html>